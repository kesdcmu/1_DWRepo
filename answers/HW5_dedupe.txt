.read target/compiled/nyc_transit/analyses/dedupe.sql

-- Analysis selecting the most recent taxi trip for each pickup location using QUALIFY
-- Source: Adapted from Week 5 materials, duckdb.org, and ChatGPT

SELECT 
    * -- Select all columns from the taxi trips fact table
FROM 
    {{ ref('mart__fact_all_taxi_trips') }} -- Referencing the fact table for all taxi trips, ref vs hard code
QUALIFY 
    ROW_NUMBER() OVER (
        PARTITION BY PUlocationID  -- Partition data by pickup location ID
        ORDER BY pickup_datetime DESC -- Order trips within each partition by pickup datetime in descending order
    ) = 1; -- Use QUALIFY to filter for the most recent trip per pickup location


┌─────────┬─────────────────────┬─────────────────────┬──────────────┬──────────────┬──────────────┬──────────────┐
│  type   │   pickup_datetime   │  dropOff_datetime   │ duration_min │ duration_sec │ PUlocationID │ DOlocationID │
│ varchar │      timestamp      │      timestamp      │    int64     │    int64     │    double    │    double    │
├─────────┼─────────────────────┼─────────────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│ fhvhv   │ 2021-12-31 23:40:54 │ 2021-12-31 23:57:55 │           17 │         1021 │        108.0 │         89.0 │
│ fhvhv   │ 2021-12-31 23:58:05 │ 2022-01-01 00:12:49 │           14 │          884 │        198.0 │         37.0 │
│ fhvhv   │ 2021-12-31 23:52:50 │ 2022-01-01 00:01:28 │            9 │          518 │        146.0 │          7.0 │
│ fhvhv   │ 2021-12-31 23:53:15 │ 2021-12-31 23:59:34 │            6 │          379 │         78.0 │        126.0 │
│ fhvhv   │ 2021-12-31 23:58:43 │ 2022-01-01 00:09:48 │           11 │          665 │        256.0 │         80.0 │
│ fhvhv   │ 2021-12-31 23:56:33 │ 2022-01-01 00:13:36 │           17 │         1023 │         66.0 │         80.0 │
│ fhvhv   │ 2021-12-31 23:59:26 │ 2022-01-01 00:09:45 │           10 │          619 │        169.0 │         47.0 │
│ fhvhv   │ 2021-12-31 23:56:13 │ 2022-01-01 00:01:08 │            5 │          295 │        242.0 │        208.0 │
│ fhvhv   │ 2021-12-31 23:48:22 │ 2021-12-31 23:51:42 │            3 │          200 │        265.0 │        191.0 │
│ fhvhv   │ 2021-12-31 23:56:45 │ 2022-01-01 00:08:19 │           12 │          694 │         13.0 │        246.0 │
│ fhvhv   │ 2021-12-31 23:28:43 │ 2021-12-31 23:38:26 │           10 │          583 │         44.0 │         84.0 │
│ fhvhv   │ 2021-12-31 23:52:57 │ 2021-12-31 23:57:14 │            5 │          257 │         81.0 │        254.0 │
│ fhvhv   │ 2021-12-31 21:59:51 │ 2021-12-31 22:06:35 │            7 │          404 │        109.0 │        109.0 │
│ fhvhv   │ 2021-12-31 23:43:29 │ 2022-01-01 00:07:12 │           24 │         1423 │        160.0 │        158.0 │
│ fhvhv   │ 2021-12-31 23:54:09 │ 2022-01-01 00:04:54 │           10 │          645 │        255.0 │         80.0 │
│ fhvhv   │ 2021-12-31 23:36:34 │ 2021-12-31 23:52:15 │           16 │          941 │         19.0 │        197.0 │
│ yellow  │ 2022-01-01 14:48:11 │ 2022-01-01 15:09:25 │           21 │         1274 │         70.0 │        101.0 │
│ fhvhv   │ 2021-12-31 19:54:47 │ 2021-12-31 20:04:48 │           10 │          601 │        111.0 │        181.0 │
│ fhvhv   │ 2021-12-31 23:57:02 │ 2022-01-01 00:09:02 │           12 │          720 │        263.0 │        161.0 │
│ fhvhv   │ 2021-12-31 23:48:49 │ 2022-01-01 00:09:59 │           21 │         1270 │          9.0 │        258.0 │
│   ·     │          ·          │          ·          │            · │           ·  │           ·  │          ·   │
│   ·     │          ·          │          ·          │            · │           ·  │           ·  │          ·   │
│   ·     │          ·          │          ·          │            · │           ·  │           ·  │          ·   │
│ fhvhv   │ 2021-12-31 23:49:41 │ 2021-12-31 23:54:11 │            5 │          270 │        200.0 │        220.0 │
│ fhvhv   │ 2021-12-31 23:58:47 │ 2022-01-01 00:03:50 │            5 │          303 │        227.0 │        228.0 │
│ fhvhv   │ 2021-12-31 15:01:43 │ 2021-12-31 15:32:49 │           31 │         1866 │         27.0 │         33.0 │
│ fhvhv   │ 2021-12-31 23:56:18 │ 2022-01-01 00:12:58 │           16 │         1000 │        101.0 │        265.0 │
│ fhvhv   │ 2021-12-31 23:59:58 │ 2022-01-01 00:04:10 │            5 │          252 │        159.0 │        167.0 │
│ fhvhv   │ 2021-12-31 23:58:55 │ 2022-01-01 00:24:27 │           26 │         1532 │        164.0 │        255.0 │
│ fhvhv   │ 2021-12-31 23:44:15 │ 2022-01-01 00:05:46 │           21 │         1291 │         49.0 │        233.0 │
│ fhvhv   │ 2021-12-31 23:52:27 │ 2022-01-01 00:05:03 │           13 │          756 │        126.0 │         42.0 │
│ fhvhv   │ 2021-12-31 23:56:13 │ 2022-01-01 00:04:42 │            8 │          509 │        234.0 │        148.0 │
│ fhvhv   │ 2021-12-31 23:51:41 │ 2021-12-31 23:58:39 │            7 │          418 │         95.0 │        196.0 │
│ fhvhv   │ 2021-12-31 23:45:11 │ 2021-12-31 23:50:37 │            5 │          326 │        112.0 │        255.0 │
│ yellow  │ 2022-01-24 21:19:02 │ 2022-01-24 21:47:57 │           28 │         1735 │        158.0 │         74.0 │
│ fhvhv   │ 2021-12-31 23:48:00 │ 2021-12-31 23:55:07 │            7 │          427 │         83.0 │        129.0 │
│ fhvhv   │ 2021-12-31 23:42:06 │ 2021-12-31 23:56:06 │           14 │          840 │        157.0 │        148.0 │
│ fhvhv   │ 2021-12-31 22:31:13 │ 2021-12-31 23:04:00 │           33 │         1967 │        172.0 │        232.0 │
│ fhvhv   │ 2021-12-31 23:56:34 │ 2022-01-01 00:02:59 │            6 │          385 │        243.0 │        244.0 │
│ fhvhv   │ 2021-12-31 23:58:17 │ 2022-01-01 00:21:54 │           23 │         1417 │        138.0 │        142.0 │
│ fhvhv   │ 2021-12-31 16:17:26 │ 2021-12-31 16:31:00 │           14 │          814 │          8.0 │          7.0 │
│ fhvhv   │ 2021-12-31 23:58:40 │ 2022-01-01 00:07:16 │            9 │          516 │          7.0 │        223.0 │
│ yellow  │ 2021-12-31 17:51:52 │ 2021-12-31 17:56:49 │            5 │          297 │         12.0 │         13.0 │
├─────────┴─────────────────────┴─────────────────────┴──────────────┴──────────────┴──────────────┴──────────────┤
│ 264 rows (40 shown)                                                                                   7 columns │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘