D .read target/compiled/nyc_transit/analyses/taxi_trips_no_valid_pickup_location_id.sql

-- Analysis to find taxi trips that lack a corresponding pickup location (Anti-Join)
-- Source: Adapted from Week 5 materials, duckdb.org, and ChatGPT

SELECT 
    * -- Select everything from the taxi trips fact table
FROM 
    {{ ref('mart__fact_all_taxi_trips') }} tt -- Fact table for all taxi trips, ref vs hard code 
WHERE 
    NOT EXISTS ( -- Apply an anti-join to select trips without a matching location
        SELECT 
            1
        FROM 
            {{ ref('mart__dim_locations') }} dl -- Referencing the dimension table for locations
        WHERE 
            tt.pulocationid = dl.locationid -- Condition for matching pickup location in the locations table
    );

┌─────────┬─────────────────────┬─────────────────────┬──────────────┬──────────────┬──────────────┬──────────────┬────────────┬─────────┬─────────┬──────────────┐
│  type   │   pickup_datetime   │  dropOff_datetime   │ duration_min │ duration_sec │ PUlocationID │ DOlocationID │ LocationID │ Borough │  Zone   │ service_zone │    
│ varchar │      timestamp      │      timestamp      │    int64     │    int64     │    double    │    double    │   int32    │ varchar │ varchar │   varchar    │    
├─────────┼─────────────────────┼─────────────────────┼──────────────┼──────────────┼──────────────┼──────────────┼────────────┼─────────┼─────────┼──────────────┤    
│ fhv     │ 2021-04-22 13:08:00 │ 2021-04-22 14:03:06 │           55 │         3306 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:53:39 │ 2021-04-22 15:21:51 │           88 │         5292 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:41:16 │ 2021-04-22 14:08:13 │           27 │         1617 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:51:13 │ 2021-04-22 15:02:04 │           71 │         4251 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:43:23 │ 2021-04-22 14:31:52 │           48 │         2909 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:17:44 │ 2021-04-22 16:27:49 │          190 │        11405 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:48:49 │ 2021-04-22 14:18:30 │           30 │         1781 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:55:42 │ 2021-04-22 14:44:24 │           49 │         2922 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:50:00 │ 2021-04-22 14:13:00 │           23 │         1380 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:02:00 │ 2021-04-22 13:07:00 │            5 │          300 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:56:00 │ 2021-04-22 14:21:00 │           25 │         1500 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:00:00 │ 2021-04-22 13:50:00 │           50 │         3000 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:30:00 │ 2021-04-22 14:00:00 │           30 │         1800 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:00:00 │ 2021-04-22 13:10:00 │           10 │          600 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:20:00 │ 2021-04-22 13:30:00 │           10 │          600 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:40:00 │ 2021-04-22 14:00:00 │           20 │         1200 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:57:00 │ 2021-04-22 14:27:00 │           30 │         1800 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:12:00 │ 2021-04-22 13:30:00 │           18 │         1080 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:00:00 │ 2021-04-22 13:35:00 │           35 │         2100 │              │              │            │         │         │              │    
│ fhv     │ 2021-04-22 13:10:00 │ 2021-04-22 13:40:00 │           30 │         1800 │              │              │            │         │         │              │    
│  ·      │          ·          │          ·          │            · │           ·  │      ·       │      ·       │     ·      │    ·    │    ·    │      ·       │    
│  ·      │          ·          │          ·          │            · │           ·  │      ·       │      ·       │     ·      │    ·    │    ·    │      ·       │    
│  ·      │          ·          │          ·          │            · │           ·  │      ·       │      ·       │     ·      │    ·    │    ·    │      ·       │    
│ fhv     │ 2021-01-09 02:24:18 │ 2021-01-09 02:53:54 │           29 │         1776 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 02:15:00 │ 2021-01-09 02:26:00 │           11 │          660 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 02:56:00 │ 2021-01-09 03:15:00 │           19 │         1140 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 02:36:00 │ 2021-01-09 03:00:00 │           24 │         1440 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 02:45:00 │ 2021-01-09 03:00:00 │           15 │          900 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 02:19:00 │ 2021-01-09 02:40:00 │           21 │         1260 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 02:26:29 │ 2021-01-09 02:36:08 │           10 │          579 │        210.0 │              │            │         │         │              │    
│ fhv     │ 2021-01-09 02:48:51 │ 2021-01-09 03:08:36 │           20 │         1185 │        150.0 │              │            │         │         │              │    
│ fhv     │ 2021-01-09 02:41:26 │ 2021-01-09 02:53:04 │           12 │          698 │         22.0 │              │            │         │         │              │    
│ fhv     │ 2021-01-09 02:56:26 │ 2021-01-09 03:08:36 │           12 │          730 │         29.0 │              │            │         │         │              │    
│ fhv     │ 2021-01-09 02:35:00 │ 2021-01-09 03:01:00 │           26 │         1560 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 03:36:30 │ 2021-01-09 04:19:51 │           43 │         2601 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 03:37:00 │ 2021-01-09 03:52:00 │           15 │          900 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 03:45:58 │ 2021-01-09 03:55:38 │           10 │          580 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 03:05:00 │ 2021-01-09 03:19:00 │           14 │          840 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 03:58:55 │ 2021-01-09 04:06:14 │            8 │          439 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 03:45:00 │ 2021-01-09 04:23:00 │           38 │         2280 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 03:25:00 │ 2021-01-09 03:35:00 │           10 │          600 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 03:35:00 │ 2021-01-09 03:47:00 │           12 │          720 │              │              │            │         │         │              │    
│ fhv     │ 2021-01-09 03:35:29 │ 2021-01-09 03:55:50 │           20 │         1221 │        210.0 │              │            │         │         │              │    
├─────────┴─────────────────────┴─────────────────────┴──────────────┴──────────────┴──────────────┴──────────────┴────────────┴─────────┴─────────┴──────────────┤    
│ 284773 rows (40 shown)                                                                                                                               11 columns │    
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘    
D